<!doctype html public "awesomeniz">
<html>
  <head>
    <meta charset="utf-8" />
    <title>A3 - Example 13</title>
  </head>
  <body style="background: #222">
    
    <div id="container">
      
    </div>
    <!--div id="vignette" style="width:900px; height:440px; position: absolute; left: 8px; top: 8px; background: url(vignette.png)">
      
    </div-->
        
    <!-- Utilities -->
    <script src="../js/rAF.js"></script>
    
    <!-- Namespace -->
    <script src="/js/A3.js"></script>
    
    <!-- Math -->
    <script src="/js/core/math/Matrix3.js"></script>
    <script src="/js/core/math/Matrix4.js"></script>
    <script src="/js/core/math/Vector2.js"></script>
    <script src="/js/core/math/Vector3.js"></script>
    <script src="/js/core/math/Vector4.js"></script>
    
    <!-- Basic -->
    <script src="/js/core/Object3D.js"></script>
    <script src="/js/core/Utility.js"></script>
    
    <!-- Engine -->
    <script src="/js/core/render/textures/Texture.js"></script>
    <script src="/js/core/render/textures/EnvironmentMap.js"></script>
    <script src="/js/core/render/shaders/Shader.js"></script>
    <script src="/js/core/render/shaders/ShaderLibrary.js"></script>
    
    <!-- Engine -->
    <script src="/js/core/render/Renderer.js"></script>
    <script src="/js/core/scene/BasicScene.js"></script>
    <script src="/js/core/camera/BasicCamera.js"></script>
    
    <!-- Mesh & Geometry -->
    <script src="/js/core/objects/Mesh.js"></script>
    <script src="/js/core/objects/geometric/Vertex.js"></script>
    <script src="/js/core/objects/geometric/Face3.js"></script>
    <script src="/js/core/objects/geometric/Face4.js"></script>
    <script src="/js/core/objects/geometric/Geometry.js"></script>
    
    <!-- Lights -->
    <script src="/js/core/objects/lights/Light.js"></script>
    <script src="/js/core/objects/lights/AmbientLight.js"></script>
    <script src="/js/core/objects/lights/DirectionalLight.js"></script>
    <script src="/js/core/objects/lights/PointLight.js"></script>
    
    <!-- Primitives -->
    <script src="/js/core/objects/primitives/Cube.js"></script>
    <script src="/js/core/objects/primitives/Sphere.js"></script>
    <script src="/js/core/objects/primitives/Plane.js"></script>
    
    <!-- Remote -->
    <script src="/js/core/remote/MeshLoader.js"></script>
    <script src="/js/core/remote/ShaderLoader.js"></script>
    
    <!-- Shaders -->
    <script data-src="/shaders/chunks/lighting.glsl" data-type="chunk" data-name="Lighting"></script>
    <script data-src="/shaders/pink/vertex.glsl" data-type="vertex" data-name="Pink"></script>
    <script data-src="/shaders/pink/fragment.glsl" data-type="fragment" data-name="Pink"></script>
    <script data-src="/shaders/particle/vertex.glsl" data-type="vertex" data-name="Particle"></script>
    <script data-src="/shaders/particle/fragment.glsl" data-type="fragment" data-name="Particle"></script>
    <script data-src="/shaders/normals/vertex.glsl" data-type="vertex" data-name="Normals"></script>
    <script data-src="/shaders/normals/fragment.glsl" data-type="fragment" data-name="Normals"></script>
    <script data-src="/shaders/phonglambert/vertex.glsl" data-type="vertex" data-name="PhongLambert"></script>
    <script data-src="/shaders/phonglambert/fragment.glsl" data-type="fragment" data-name="PhongLambert"></script>
    <script data-src="/shaders/basic/vertex.glsl" data-type="vertex" data-name="Basic"></script>
    <script data-src="/shaders/basic/fragment.glsl" data-type="fragment" data-name="Basic"></script>
    
    <script>
    
      var cs = (document.querySelectorAll('script[data-type="chunk"]'));
      var vs = (document.querySelectorAll('script[data-type="vertex"]'));
      var fs = (document.querySelectorAll('script[data-type="fragment"]'));
      var csCount = cs.length;
      var vsCount = vs.length;
      var fsCount = fs.length;
      var csVsFsCount = csCount+vsCount+fsCount;
          
      for(var vss = 0; vss < vsCount; vss++){
        var script = vs[vss];
        new A3.ShaderLoader(
          script.dataset['src'],
          script.dataset['name'],
          'vertex',
          onShaderLoad).load();
      };
      
      for(var fss = 0; fss < fsCount; fss++){
        var script = fs[fss];
        new A3.ShaderLoader(
          script.dataset['src'],
          script.dataset['name'],
          'fragment',
          onShaderLoad).load();
      };
      
      for(var css = 0; css < csCount; css++){
        var script = cs[css];
        new A3.ShaderLoader(
          script.dataset['src'],
          script.dataset['name'],
          'chunk',
          onShaderLoad).load();
      };
      
      function onShaderLoad() {
        csVsFsCount--;
        if(!csVsFsCount) {
          onShadersLoaded();
        }
      }
      
      var envMap = new A3.EnvironmentMap({
                  px: "environments/interstellar/pos-x.jpg",
                  nx: "environments/interstellar/neg-x.jpg",
                  py: "environments/interstellar/pos-y.jpg",
                  ny: "environments/interstellar/neg-y.jpg",
                  pz: "environments/interstellar/pos-z.jpg",
                  nz: "environments/interstellar/neg-z.jpg"
              });
    
      function onShadersLoaded() {
        
        var SIZE = 110,
          
          loader = new A3.MeshLoader("monkey-high.a3", function(geometry) {
            geometry.colors = [];
            
            for(var v = 0; v < geometry.vertices.length; v++) {
              geometry.colors.push(new A3.V3(1,1,1));
                /*new A3.V3(
                  Math.max(0, Math.min(1, geometry.vertices[v].position.x)),
                  Math.max(0, Math.min(1, geometry.vertices[v].position.y)),
                  Math.max(0, Math.min(1, geometry.vertices[v].position.z))
                )*/
                
              
              geometry.vertices[v].position.x *= SIZE;
              geometry.vertices[v].position.y *= SIZE;
              geometry.vertices[v].position.z *= SIZE;
              
            }
            
            geometry.updateVertexPositionArray();
            geometry.updateVertexColorArray();
            
            onDataLoaded(geometry);
          });
        loader.load();
        
        function onDataLoaded(geometry) {
          var phase   = 0,
            count   = 0,
            width   = 900,
            height    = 440,
            aspect    = width / height,
            renderer  = new A3.R(width,height, { clearColor: new A3.V4(0.1,0.1,0.1,1.0) }),
            scene     = new A3.Scene(),
            camera    = new A3.Camera(45, aspect, 0.1, 2000),
            sphereGeom  = new A3.Sphere(100, 40, 40),
            world   = new A3.Mesh({
              geometry: geometry,
              shader: A3.ShaderLibrary.get({
                type:"Phong"
                ,environmentMap: envMap
                //,texture: new A3.Texture("earth.jpg", 0)
              })
              //,renderType:"Particle"
            });
            
            world.position.y = 30;
            
            renderer.clear();
            
            ambientLight = new A3.AmbientLight(new A3.V3(
              1,1,1
            ), 0);
            directionalLight = new A3.DirectionalLight(new A3.V3(
              1,1,1
            ), 1);
            directionalLight2 = new A3.DirectionalLight(new A3.V3(
              1,1,1
            ), 1.0);
            
            directionalLight2.position = new A3.V3(-45, -30, 10);
          
            scene.add(world);
            scene.add(ambientLight);
            scene.add(directionalLight);
            scene.add(directionalLight2);
            //
            directionalLight.position.x = 100;
            directionalLight.position.y = 100;
            directionalLight.position.z = 130;
            
            document.getElementById('container').appendChild(renderer.domElement);
            camera.position.z = 500;
            camera.position.y = 130;
            
            //phase = 7.9;
            function update() {
              
              renderer.render(scene, camera);
              requestAnimFrame(update);
            
            }
            var mouseDown = false, lastMouseX = null, lastMouseY = null;
            function onMouseDown() { mouseDown = true; lastMouseX = event.clientX; lastMouseY = event.clientY;
              
            }
            
            function onMouseUp() { mouseDown = false;
              
            }
            function onMouseMove(event) {
              if(mouseDown) {
                var thisMouseX = event.clientX;
                var thisMouseY = event.clientY;
                
                world.rotation.x += (thisMouseY - lastMouseY) * 0.01;
                world.rotation.y += (thisMouseX - lastMouseX) * 0.01;
                
                lastMouseY = thisMouseY;
                lastMouseX = thisMouseX;
                
              }
            }
            
            document.addEventListener('mousedown', onMouseDown, true);
            document.addEventListener('mouseup', onMouseUp, true);
            document.addEventListener('mousemove', onMouseMove, true);
            
            requestAnimFrame(update);
          }
        }
    </script>
  </body>
</html>